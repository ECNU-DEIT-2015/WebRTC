## 产品创意
>### 灵感来源
>><br>在我们的学习与工作中，总是免不了跟图打交道，比如我们看一本小说，可以通过画图来理清故事里面的人物关系，读完一篇科技文献，可以画图来表示事物之间的概念与逻辑关系；工作中的业务关系也可以用图来表示其中的流程与逻辑关系。有研究表明，在人脑的认知中，对图形的敏感程度要高于对文字的敏感程度，图表可以用简单的线条与图形将需要复杂文字表述的关系清晰地展现出来，加速人们对事物的认知。随着互联网的不断发展，教育也逐渐朝着信息化的方向发生了巨大的改变；网络在线课程的出现很大程度上改变了教育的方式，为学习者提供了学习各种知识的途径，促进了学习终身化与教育信息化发展。但目前的网络在线课程都是教师将课程放在网络平台上，学习者根据自己的需要选择性的学习。<br>
>### 目标群体
>><br>我们认为在这样的学习过程中，教师与学习者之间缺乏实时互动，不利于教学的进展；教师也不能及时获得反馈了解学习者的学习情况，为学生提供个性化的教学，学习者的问题在学习过程中也难以得到解决，使得网络在线课程的教学效率远不如传统教育。同时，人与人之间的协作能力也越来越受到人们的重视，在信息化的背景下如何增强人的协作能力，也成为了一大难题。
>### 创意过程
>><br>我们想到要搭建一个不仅可以多人在线协作画图，而且可以实现实时在线远程演示的网络平台；业务工作人员可以在线构建业务流程图，学生可以在线合作画阅读概念图，物理或数学等教师可以在线远程上课，与学生进行实时沟通并及时解决学习问题。所以，我们的平台包括了以下几个部分（如图）：<br><div align=center>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/part.png)</div>
<br>我们需要完成登录、注册、新建文件、使用模板、插入图片、文件编辑、文件搜索、文件删除、文件保存、删除好友、搜索添加好友、文字聊天、语音视频、在线画布和文件回收站等功能。其中在新建文件创建的画布中进行文件的编辑、多人在线协作、保存文件和语音视频通话是最重要的也是最难实现的功能。<br>
<br>

## 创意
>我们经常玩你画我猜的游戏，在这个游戏里，每个人的手机上都会有一张画布，画的人可以在上面进行涂鸦，而猜的人可以看见画的人的图像，自己却不能操作，也不能方便地与朋友交流。根据这一现象，于是我们就想到了是否可以做一个一张画布多人在线实时操作的平台，并且在操作过程中添加与好友语音视频聊天的功能，方便好友之间的交流。

## 网站原型
><br>**网站介绍**。我们会在网站首页加入视频来介绍我们网站提供给哪些功能，以及用户如何使用我们的网站。通过视频、图片展示和必要的文字说明让用户对我们的网站产生兴趣，然后可以注册使用我们的网站。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%871.png)
<br><br><hr>**登录和注册**。用户进入个人课程模块需要网站的邮箱账户和密码，登录功能需要识别账号是否是邮箱，用户可以自己注册账号。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%872.png)![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%873.png)
<br><br><hr>**新建文件**。用户可以新建空白文件在画布内进行操作，也可以使用自己的模板进行创作。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%874.png)![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%875.png)
<br><br><hr>**插入图片**。用户在创作过程中可以点击添加图片，从本地文件中添加图片到文件中，并且在创作过程中可以呼叫好友协作。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%877.png)![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%878.png)
<br><br><hr>**呼叫好友**。用户可以通过好友管理界面或者文件编辑界面点击呼叫好友，选中好友与好友进行协作。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%876.png)
<br><br><hr>**文件管理**。文件的编辑指在画布上进行画图或者演示的操作，同时可以根据文件名称搜索文件，保存文件与删除文件的操作，用户还可以将文件保存到本地文件夹中。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%8714.png)![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%8713.png)
<br><br><hr>**好友管理**。在好友列表中用户可以删除自己的好友，也可以选择好友给好友发文字消息或者邀请好友协同创作，并且与好友进行语音视频聊天。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%8711.png)
<br><br><hr>**在线画布、语音视频**。多名用户可以同时在线编辑一个文件，并且在画布中对内容进行添加、修改和删除。同时，用户在好友界面或者文件编辑界面可以邀请好友进行语音和视频的在线交流。<br><br>![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%8715.png)
<br><br><hr>**文件回收站**。用户删除的文件会暂时放进回收站，不会永久地删除，用户进入回收站可以恢复放进回收站的文件，也可以将回收站的文件永久删除。
![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E5%8E%9F%E5%9E%8B%E5%9B%BE%E7%89%8714.png)

## 我在创意阶段所做的贡献
>在创意阶段中，我提出了在线协作画图的主题，我与小组成员讨论了需求分析，纠正了一些错误的观点，同时为解决方案的设计提出了重要的建议，也提供了部分重要的解决方案，并且通过主要功能板块的设计，分析出实现登录、注册、新建文件、使用模板、插入图片、文件编辑、文件搜索、文件删除、文件保存、删除好友、搜索添加好友、文字聊天、语音视频、在线画布和文件回收站等各个功能所需要的基本技术和基本方法。

## 需求分析
><br>我们开发的是免费的在线网页版作图工具，名为WebRTC，将通讯工具、认知工具以及学习空间集使用起来，比单纯使用ＱＱ、Visio、其他虚拟学习空间更具优势，非常简单有效。其优点如下：<br>
<br>1) &nbsp;资源管理<br><br>WebRTC有丰富的文件管理功能。你注册一个WebRTC账号之后，你就可以随时使用和保存自己的文件，而不必担心文件丢失。导航栏中新建文件、个人文件、协作文件和回收站让文件资源的查找和整理变得异常简单，用户可以创建新的空白的文件；可以创建带有模板的新文件；可以打开个人文件，并对旧文件进行查看、修改、删除、分享；可以打开协作文件，并对之前的文件进行查看、修改、分享等；可以对文件进行搜索；可以删除文件并在回收站中还原；甚至可以在文件中插入本机上的图片。<br>
<br>2) &nbsp;实时交流<br><br>用户可以加入创建的公共小组，或者创建自己的私人小组，并邀请协作成员加入。在协作学习中，小组成员可以利用WebRTC的提供的语音视频通话即时交流、互相讨论，不仅仅通过文字来进行交流，文字交流具有耗时性和延时性，通过语音和视频可以使小组成员更快更了解其他成员的状态和想法，这样能更好的对知识进行深入学习，与此同时，基于HTML5 技术做到无延迟协作，方便两个或多个人同时对一个文件协作编辑和沟通共同制作概念图，不仅能够提高效率，还可以增进成员中的团结意识。<br>
<br>3) &nbsp;操作简单<br><br>注册简单。只需要输入一个邮箱地址和用户名密码即可，或者通过第三方账号登录；可以建立空白文档，也可以根据自己的需要选择合适的模板，根据提示操作即可；制作概念图时既可以直接把需要的图形拖拽到画布编辑，也可以自主画图；采用实时保存机制，每一步操作之后都自动保存，做完之后你可以保存图片，然后插入到其他文件中，方便简单又实用，而且也会让作品看起来更加专业；能够快速还原误删除的文件。     

## 设计的功能列表以及其完成情况

 设计的功能|承担该功能的组员|任务完成度
 --|--|--
  登录注册|李敏|100%
  视频文档介绍|李敏|100%
  搜索文件|李敏|100%
  新建保存文件|李敏|100%
  插入图片|李敏|100%
  加好友|崔红洋|50%
  搜索好友|崔红洋|50%
  回收站|崔红洋|100%
  个人文件管理|崔红洋|100%
  编辑图片|崔红洋|100%
  协作文件管理|崔红洋|100%
  视频通信|吴清泽|90%
  写字板同步|吴清泽|90%

# 产品技术方案
> 我主要实现了写字板的数据同步和基于WebRTC的视频通信。<br><br>
**写字板**<br>
写字板矩形、圆形、直线、曲线、箭头、橡皮、后退、前进、清楚、保存功能的实现是基于https://github.com/movever/draw-boad
的github项目，我对其中的保存功能做了更改，使得canvas相对于不同使用场景做出合适的保存效果。比如，如果是新文件的保存，会保存到新文件的表中，如果是对旧文件的修改，会仅将修改的部分保存<br><br>
**写字板的数据同步**<br>
![image](https://github.com/wuqingze/jj/blob/master/%E6%9C%AA%E5%91%BD%E5%90%8D%E6%96%87%E4%BB%B6.png?raw=true)
为了提升用户体验，每隔100ms使用web worker开一个线程用来遍历写字板，比较写字板与为更新前的写字板存在的差异数据并保存下来，让后使用socket.io将需要更新的数据发送给服务器，服务器将数据发送给客户端2，然后客服端2将接收自客户端1的数据更新到写字板。基于这一个思路，可以实现写字板数据同步的效果。<br><br>
**视频通信**<br>
基于谷歌webrtc开源框架实现端对端的视频对话效果。webrtc主要有两个过程，一个是需要服务器的参与为通信双方建立连接；另一个是在实现连接后端点间可以摆脱服务器直接实现端对端通信。<br><br>
**建立通信信道过程**
![image](https://github.com/wuqingze/jj/blob/master/RTCPeerConnection%E8%BF%87%E7%A8%8B.png?raw=true)<br><br>
**端对端传输数据**
![image](https://github.com/wuqingze/jj/blob/master/RTCDataChannel%E8%BF%87%E7%A8%8B.png?raw=true)

## 我在小组中的分工
>我主要实现了写字板的数据同步和基于谷歌框架webrtc实现端对端视频通信。同时作为组长，为小组成员解决项目过程中的问题也是我的责任，小组的另外两位成员小项目开发的过程中学到了web开发的技术也是我最开心的一点。同时这次项目开发也锻炼了我在团队合作、统筹规划的能力。<br><br>
李敏对项目的贡献很大，她是项目提交次数最多的成员，很感谢她对项目的认真负责。同时崔红洋也很努力的完成了她的工作，实现HTML页面，在项目开发的过程中，我们经常交流，崔同学的认真让人很感动。
    
    组员|分数
 --|--
  李敏|10
  崔红洋|10
  吴清泽|10

## 我的编程实践活动
### 我的代码
>
```javascript
//server

'use strict';

var os = require('os');
var nodeStatic = require('node-static');
var fs = require('fs');
// var http = require('http');
// var socketIO = require('socket.io');

// var fileServer = new(nodeStatic.Server)();
// var app = http.createServer(function(req, res) {
//     fileServer.serve(req, res);
// }).listen(8080);

// var express = require('express');
// app.use(express.static('public'));
// app.use("/", express.static(__dirname));
// var bodyParser = require('body-parser');
// app.use(bodyParser.urlencoded({extended: false}));
// app.use(bodyParser.json());
// var io = socketIO.listen(app);

// var io = socketIO.listen(app_);

var express = require('express');
var app = express();
// // app.use(express.static('public'));
app.use("/", express.static(__dirname));
var bodyParser = require('body-parser');
app.use(bodyParser.urlencoded({extended: false}));
app.use(bodyParser.json());
// var io = socketIO.listen(app);

var http = require('http').Server(app);
var io = require("socket.io")(http);

app.get('/', function(req, res){
  res.sendFile(__dirname+"/index.html");
});

app.get("/jj", function(req,res){
  res.sendFile(__dirname+"/web/shouye.html");
});


var login_user = {};
var connectCounter = 0;


var tempimage = "";
var messages = {};
var connection_pair = {};

// numClients
// io.sockets.on("connection", function(socket){
  io.on("connection", function(socket){
    connectCounter ++;
    console.log("connected user count",connectCounter);
    socket.on("array_changed", function(msg){
        console.log("array_changed");
        socket.broadcast.emit("array_changed", msg);
    });

    socket.on("login", function(msg){
      console.log('login message',msg);
      console.log('message email',msg['email']);
      console.log('message password', msg['password']);
      var connection = mysqlconnection();
      // var querysql = "select password from user where email='"+msg['email']+"';";
      var querysql = "select * from user where email='"+msg['email']+"' and password='"+msg['password']+"'";
      connection.query(querysql,function(err, rows, fields) {    
        // console.log("rows length", rows.length);
        if(rows.length == 1){
          var cookie = Math.random().toString();
          login_user[cookie.toString()] = msg['email'];
          socket.emit("return_login", {"verified":true,"cookie":cookie});
        }else{
          socket.emit("return_login", false);
        }
      });
      connection.end();      
    });


    socket.on("personal_file", function(msg){
      var connection = mysqlconnection();
      var querysql = "select * from personal_file where email='nongxiaolang@foxmail.com'";
      connection.query(querysql, function(err, rows, fields) {
        socket.emit("personal_file",rows);
        connection.end();
      });
    });

    socket.on("cooperation_file", function(msg){
      var connection = mysqlconnection();
      var querysql = "select * from cooperation_file where email='nongxiaolang@foxmail.com'";
      connection.query(querysql, function(err, rows, fields) {
        socket.emit("cooperation_file",rows);
        connection.end();
      });
    });

    socket.on("bin_file", function(msg){
      var connection = mysqlconnection();
      var querysql = "select * from bin_file where email='nongxiaolang@foxmail.com'";
      connection.query(querysql, function(err, rows, fields) {
        socket.emit("bin_file",rows);
        connection.end();
      });
    });

    socket.on("new_bin_file", function(msg){
      var connection = mysqlconnection();
      var querysql = "select * from bin_file where email='nongxiaolang@foxmail.com'";
      connection.query(querysql, function(err, rows, fields) {
        socket.emit("new_bin_file",rows);
        connection.end();
      });
    });

    socket.on("friend_file", function(msg){

      var cookie = msg['cookie'].split(';')[0];
      var user = login_user[cookie];
      var querysql = "select * from user where email in (select friend_email from friend where email='"+user+"')";
      var connection = mysqlconnection();
      console.log("msg['cookie']",msg['cookie'].split(";")[0]);
      console.log('friend file cookie', cookie, login_user[cookie]);
      connection.query(querysql, function(err, rows, fields) {
        socket.emit("friend_file",rows);
        connection.end();
      });
    });

    socket.on("save_empty_file", function(msg){
      var imgData = msg['imgData'];
      var base64Data = imgData.replace(/^data:image\/\w+;base64,/, "");
      var dataBuffer = new Buffer(base64Data, 'base64');
      
      var cookie = msg['cookie'].split(';')[0];
      var email = login_user[cookie];

      
      var querysql = "select count(*) from personal_file where email='"+email+"'";
      var querysql1 = "insert into personal_file(email, personal_file_id, image, headline, introduction, labels) value(?,?,?,?,?,?)";
      var connection = mysqlconnection();

      connection.query(querysql, function(err, rows, fields) {
        var count = rows[0]['count(*)'];
        var imagepath = "images/"+email+"/personal_file/"+(count+1).toString()+".png";
        var headline = msg['headline'];
        var introduction = msg['introduction'];
        var labels = msg['labels'];
        connection.query(querysql1,[email, email+(count+1).toString(),"../"+imagepath, headline, introduction, labels], function(err, result){
          fs.writeFile(imagepath, dataBuffer, function(err) {
            if(err){
              socket.emit("save_empty_file",{"result":false});
            }else{
              socket.emit("save_empty_file",{"result":true});
              console.log("save successfully");
            }
          });
        });
      });


    });


    socket.on("modify_image", function(msg){
      var imagepath = msg['imagepath'].split("../")[1];
      var imgData = msg['imagedata'];
      var base64Data = imgData.replace(/^data:image\/\w+;base64,/, "");
      var dataBuffer = new Buffer(base64Data, 'base64');
      fs.writeFile(imagepath, dataBuffer, function(err) {
        if(err){
          socket.emit("modify_image",{"result":false});
        }else{
          socket.emit("modify_image",{"result":true});
          console.log("save successfully");
        }
      });
    });

    socket.on("delete_file_bin", function(msg){
      var table = msg['table'];
      var image = msg['image'];
      var cookie = msg['cookie'].split(';')[0];
      var email = login_user[cookie];

      var querysql = "select * from "+table+" where image='"+image+"'";
      var querysql1 = "delete from "+table+" where image='"+image+"'";
      console.log("querysql",querysql);
      console.log("querysql1",querysql1);
      var querysql2 = "insert into bin_file(bin_file_id,email,image,headline,introduction,labels) value(?,?,?,?,?,?)";
      var connection = mysqlconnection();
      connection.query("SET SQL_SAFE_UPDATES = 0", function(err, result){
        if(err){
          console("SET SQL_SAFE_UPDATES = 0; failed");
        }else{
          connection.query(querysql, function(err, rows, fields) {
            var row = rows[0];
            var bin_file_id;
            if(table == "personal_file"){
              bin_file_id = row['personal_file_id'];
            }else{
              bin_file_id = row['cooperation_file_id'];
            }
            var headline = row['headline'];
            var introduction = row['introduction'];
            var labels = row['labels'];
            connection.query(querysql2, [bin_file_id,email,image,headline,introduction,labels], function(err, result){
              if(err){
                console.log("bin_file_id,email,image,headline,introduction,labels",bin_file_id,email,image,headline,introduction,labels);
                console.log("insert into bin failed");
                socket.emit("delete_file_bin",{"result":false});
                connection.end();
              }else{
                connection.query(querysql1,function(err,result){
                  if(err){
                    socket.emit("delete_file_bin",{"result":false});
                  }else{
                    socket.emit("delete_file_bin",{"result":true});
                  }
                  connection.end();
                });
              }
            });
        });
        }
      });
      
    });

    socket.on("recover", function(msg){
      var table = msg['table'];
      var image = msg['image'];
      var cookie = msg['cookie'].split(';')[0];
      var email = login_user[cookie];

      var querysql = "select * from bin_file where image='"+image+"'";
      var querysql1;
      if(table=="personal_file"){
        querysql1 = "insert into personal_file(personal_file_id,email,image,headline,introduction,labels) value(?,?,?,?,?,?)";
      }else{
        querysql1 = "insert into cooperation_file(cooperation_file_id,email,image,headline,introduction,labels) value(?,?,?,?,?,?)";
      }
      var querysql2 = "delete from bin_file where image='"+image+"'";

      var connection = mysqlconnection();
      connection.query(querysql, function(err, rows, fields){
        if(err){
          console.log("querysql failed");
          socket.emit("recover",{"result":false});
        }else{
          var row = rows[0];
          var file_id = row['bin_file_id'];
          var email = row['email'];
          var image = row['image'];
          var headline = row['headline'];
          var introduction = row['introduction'];
          var labels = row['labels'];
          connection.query(querysql1,[file_id, email, image, headline, introduction, labels], function(err, result){
            if(err){
              socket.emit("recover",{"result":false});
              connection.end();
            }else{
              console.log("querysql1 insert in to personal file success");
              connection.query(querysql2,function(err, result){
                if(err){
                  socket.emit("recover",{"result":false});
                }else{
                  socket.emit("recover",{"result":true});
                }
              });
              connection.end();
            }
          });
        }
      });
    });

    socket.on("totally_delete", function(msg){
      var image = msg['image'];
      var cookie = msg['cookie'].split(';')[0];
      var email = login_user[cookie];


      var querysql = "delete from bin_file where image='"+image+"'";
      var connection = mysqlconnection();
      connection.query(querysql, function(err, result){
        if(err){
          socket.emit("totally_delete",{"result":false});
        }else{
          socket.emit("totally_delete",{"result":true});
        }
      });
      connection.end();
    });

    socket.on("call_friend", function(msg){
      // socket.emit("call_friend", {"image":msg["image"]});
      // console.log("call_friend----=====---====");
      var cookie = msg['cookie'].split(';')[0];
      var email = login_user[cookie];
      tempimage = msg['image'];
      connection_pair[msg['email']] = email;
      connection_pair[email] = msg['email'];
    });

    socket.on("call_friend_image", function(msg){
      socket.emit("call_friend_image", {"image":tempimage});
    });

    socket.on("search_friend", function(msg){

      var connection = mysqlconnection();
      var cookie = msg['cookie'].split(';')[0];
      var user = login_user[cookie];
      var friend = msg['friend'];
      var querysql = "select * from user where email in (select friend_email from friend where email='"+user+"' and friend_email like '%"+friend+"%')";
      connection.query(querysql, function(err, rows, fields){
        if(err){
          socket.emit("search_friend",{"result":false});
        }else{
          socket.emit("search_friend", {"result":true,"friends":rows});
        }
      });
      connection.end();
      // console.log("search_friend");
      // var friends = [];
      // var i0 =  parseInt(Math.random()*10);
      // for(var i=0; i<i0; i++){
      //   friends.push(i);
      // }
      // socket.emit("search_friend", {"result":true, "friends": friends});
    });

    socket.on("messages", function(msg){
      var cookie = msg['cookie'].split(';')[0];
      var user = login_user[cookie];
      if(messages[user]){
        socket.emit("messages",{"result":true,'messages':messages[user]});
      }else{
        socket.emit("messages",{'result':false});
      }
      console.log("message");
    });

    socket.on("send_message", function(msg){
      var cookie = msg['cookie'].split(';')[0];
      var user = login_user[cookie];
      var  email = msg['email'];
      var image = msg['image'];
      // messages[email] = {'friend':user};
      messages[email] = [{'friend':user,'image':image}];
    });

    socket.on("save_cooperation_file", function(msg){
      var cookie = msg['cookie'].split(';')[0];
      var user = login_user[cookie];

      var connection = mysqlconnection();
      var querysql1 = "insert into cooperation_file(cooperation_file_id,email,friend_email,image,headline,introduction,labels) value(?,?,?,?,?,?,?)";
      // connection.query(querysql,[msg['email']+msg['friend_email']+Math.random().toString(),msg['email'],msg['friend_email'],msg['image'],msg['headline'],msg['introduction'],msg['labels']], function(err,result){
      //   if(err){
      //     socket.emit("save_cooperation_file",{'result':false});
      //   }else{
      //     socket.emit("save_cooperation_file",{"result":true});
      //   }
      // });

      var imgData = msg['imgData'];
      var base64Data = imgData.replace(/^data:image\/\w+;base64,/, "");
      var dataBuffer = new Buffer(base64Data, 'base64');
      
      var cookie = msg['cookie'].split(';')[0];
      var email = login_user[cookie];
      var friend_email = connection_pair[email];
      console.log("connection_pair",connection_pair);
      var querysql = "select count(*) from cooperation_file where email='"+email+"'";
      var connection = mysqlconnection();
      
      console.log("insert to cooperation file");
      connection.query(querysql, function(err, rows, fields) {
        if(err){
          console.log("insert to cooperation file failed in select from cooperation_file");
        }else{
          var count = rows[0]['count(*)'];
          var imagepath = "images/"+email+"/cooperation_file/"+(count+1).toString()+".png";
          var headline = msg['headline'];
          var introduction = msg['introduction'];
          var labels = msg['labels'];
          console.log("cooperation_file_id",email+(count+1).toString());
          console.log("email",email);
          console.log("friend_email", friend_email);
          console.log("image",imagepath);
          console.log("introduction",introduction);
          console.log("labels",labels);
          console.log("headline",headline);
          connection.query(querysql1,[email+(count+1).toString(), email,friend_email, "../"+imagepath, headline, introduction, labels], function(err, result){
            if(err){
              console.log("insert cooperation file to database failed");
              socket.emit("save_cooperation_file",{"result":false});
            }else{
              fs.writeFile(imagepath, dataBuffer, function(err) {
                if(err){
                  console.log("insert into cooperation failed");
                  socket.emit("save_cooperation_file",{"result":false});
                }else{
                  console.log("insert into cooperation file successu");
                  socket.emit("save_cooperation_file",{"result":true});
                  console.log("save successfully");
                }
              });
            }
          });
        }
      });
      // connection.end();
    });
    // socket.on("test_cookie", function(msg){
    //   console.log(msg);
    //   console.log(msg['cookie']);
    //   console.log(login_user);
    //   console.log(login_user[msg['cookie'].split(";")[0].trim()]);
    // });


    // convenience function to log server messages on the client
    function log() {
      var array = ['Message from server:'];
      array.push.apply(array, arguments);
      socket.emit('log', array);
    }

    socket.on('message', function(message) {
        log('Client said: ', message);
        // for a real app, would be room-only (not broadcast)
        socket.broadcast.emit('message', message);
      });


      socket.on('create or join', function(room) {
        log('Received request to create or join room ' + room);

        // var numClients = io.sockets.sockets.length;
        var numClients = io.sockets.length;
        log('Room ' + room + ' now has ' + connectCounter + ' client(s)');

        if (connectCounter === 1) {
          socket.join(room);
          log('Client ID ' + socket.id + ' created room ' + room);
          socket.emit('created', room, socket.id);

        } else if (connectCounter < 10) {
          log('Client ID ' + socket.id + ' joined room ' + room);
          io.sockets.in(room).emit('join', room);
          socket.join(room);
          socket.emit('joined', room, socket.id);
          io.sockets.in(room).emit('ready');
        } else { // max two clients
          socket.emit('full', room);
        }
      });

      socket.on('ipaddr', function() {
        var ifaces = os.networkInterfaces();
        for (var dev in ifaces) {
          ifaces[dev].forEach(function(details) {
            if (details.family === 'IPv4' && details.address !== '127.0.0.1') {
              socket.emit('ipaddr', details.address);
            }
          });
        }
      });

      socket.on('bye', function(){
        console.log('received bye');
      });

      socket.on('disconnect', function() {
        connectCounter--;
        console.log("disconnected",connectCounter);
        });
    }); 

  http.listen(8080, function(){
      console.log('listening on *:8080');
    });


function mysqlconnection(){
    var mysql = require('mysql');
    var connection = mysql.createConnection({
        host: 'www.muedu.org',
        user: 'deit-2015',
        password: 'deit@2015!',
        database:'project_2015_5'
    });
    connection.connect();
    return connection;
    // connection.end();
}


// // 创建服务器
// http.createServer( function (request, response) {  
//     // 解析请求，包括文件名
//     var pathname = url.parse(request.url).pathname;
    
//     // 输出请求的文件名
//     console.log("Request for " + pathname + " received.");
    
//     // 从文件系统中读取请求的文件内容
//     fs.readFile(pathname.substr(1), function (err, data) {
//        if (err) {
//           console.log(err);
//           // HTTP 状态码: 404 : NOT FOUND
//           // Content Type: text/plain
//           response.writeHead(404, {'Content-Type': 'text/html'});
//        }else{             
//           // HTTP 状态码: 200 : OK
//           // Content Type: text/plain
//           response.writeHead(200, {'Content-Type': 'text/html'});    
          
//           // 响应文件内容
//           response.write(data.toString());        
//        }
//        //  发送响应数据
//        response.end();
//     });   
//  }).listen(8080);
```
```javascript
onmessage = function(e){
    original_array = e.data[0];
    lasted_array = e.data[1];
    var changed_data = [];
    for(var i=0; i<original_array.length; i++){
        if(original_array[i] != lasted_array[i]){
            changed_data.push(i,lasted_array[i]);
        }
    }
    var isChanged = false;
    if(changed_data.length > 0){
        isChanged = true;
    }
    var result = {"change_data":changed_data,"isChanged":isChanged}
    postMessage(result);
}
```
```javascript
//draw_angular.js

console.log("draw angular");
var socket = io.connect();
var app = angular.module('draw_app', []);
app.directive('drawcanvas', function(){
    return {
        templateUrl: 'canvas.html',
        replace: true,
        restrict: 'AE',
    }
});


app.controller("main_controller", function($http, $scope){

    $scope.drawhtml = true;
    $scope.image = "";
    $scope.xx = 1;
    $scope.ctx = undefined;
    $scope.canvas_imagedata = undefined;
    $scope.array_data  = undefined;
    window.setTimeout(add_canvas,100);
    
    // window.setTimeout(init($scope),200);
    $scope.socket = socket;
    // window.setTimeout(init_canvas($scope), 4000);

    socket.on("call_friend", function(msg){
      $scope.image = msg['image'];
    });

    $scope.remove = function(){
        if($scope.drawcanvas.length== 0){
            $scope.drawcanvas = [1];
        }else{
            $scope.drawcanvas = []; 
        }
        
    };
    window.setTimeout(function(){init_canvas($scope);init_video($scope)},1000);
    $scope.test = function(){
        // var canvas = $("canvas:first").get(0);
        // console.log(canvas.getContext("2d"));
        // console.log($scope.array_data);
        init_canvas($scope);
        init_video($scope);
    }

    $scope.only_video = function(){
        $scope.show_navigator = false;
        $scope.show_canvas = false;
        $("video:first").get(0).style.width = "300px";
        $("video:first").get(0).style.height = "200px";

        $("video:last").get(0).style.position = "absolute";
        
        $("video:last").get(0).style.width = document.body.offsetWidth.toString()+"px";
        $("video:last").get(0).style.height = (document.body.offsetHeight+80).toString()+"px";
        $("video:last").get(0).style.top = "10px";
        $("video:last").get(0).style.left = "10px";
        $("video:last").get(0).style.zIndex = "-1";
        
        console.log("width",window.innerWidth);
        console.log("height", window.innerHeight);
    }

    $scope.recover = function(){
        $scope.show_navigator = true;
        $scope.show_canvas = true;
        $("video:last").get(0).style.position = "static";
        $("video:first").get(0).style.width = "300px";
        $("video:first").get(0).style.height = "220px";

        $("video:last").get(0).style.width = "300px";
        $("video:last").get(0).style.height = "220px";
    }

    $scope.icons = function(){
        if($scope.show_icons == true){
            $scope.show_icons = false;
        }else{
            $scope.show_icons = true;
        }
    }

    $scope.save_empty_file = function(){
      console.log("save empty file",$scope.introduction);
            var canvas = $("canvas:first").get(0);
            // console.log(canvas.toDataURL());
            socket.emit('save_cooperation_file',{"introduction":$scope.introduction,"headline":$scope.headline,"cookie":document.cookie,"imgData":canvas.toDataURL(),"labels":$scope.labels});
            // console.log("introduction",$scope.introduction);
            // console.log("headline",$scope.headline);
            // console.log("labels",$scope.labels);
            socket.on("save_cooperation_file", function(msg){
                if(msg['result'] == true){ alert("新文件保存成功")}
            });
    }
    // $scope.recover = function()
    // console.log("mymain.js from main_controller");
    // var canvas = document.getElementsByTagName('canvas')[0];
    // canvas.id = "main_canvas";
    // var ctx = canvas.getContext('2d');
    // var canvas_imagedata = ctx.getImageData(0,0,990,500);
    // var array_data = new Uint8ClampedArray(canvas_imagedata.data);
});


app.controller('navigator_controller', function($http, $scope) {
  $scope.messages = false;
  $scope.m1 = "../img/message.png";
  $scope.m2 = "../img/message1.png";
  socket.emit("messages", {"cookie":document.cookie});
  socket.on("messages", function(msg){
      if(msg['result']){
          $scope.messages = msg['messages'];
      }
      console.log("messages", )
  });

  $scope.data_list = []
  $scope.$watch('search_value', function(newValue, oldValue) {
      if (newValue === oldValue) {
          return;
      }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
          $scope.data_list.push({"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/1.png"});
      }else{
          $scope.data_list.pop()
      }
      console.log("data changed");
  }, true);
});


function init_canvas(scope){
    console.log("init_canvas");
    var canvas = $("canvas:first").get(0);
    console.log("scope xx",scope.xx);   
    var img = document.createElement("img");
    // scope.socket.on("call_friend", function(msg){
    //   console.log("call_friend----=====---");
    //   img.src = msg['image'];
    //   window.setTimeout(function(){$("canvas:first").get(0).getContext('2d').drawImage(img,0,0);},1000);
    // });

    // img.src = "http://localhost:8080/images/1.png";
    // window.setTimeout(function(){$("canvas:first").get(0).getContext('2d').drawImage(img,0,0);},1000);

    // img.src = scope.image;
    // window.setTimeout(function(){$("canvas:first").get(0).getContext('2d').drawImage(img,0,0);},1000);
    scope.socket.emit("call_friend_image",{"xx":"xx"});
    scope.socket.on("call_friend_image", function(msg){
      img.src = msg['image'];
      window.setTimeout(function(){$("canvas:first").get(0).getContext('2d').drawImage(img,0,0);},1000);
    });
    canvas.id = "main_canvas";
    scope.ctx = $("canvas:first").get(0).getContext('2d');
    scope.canvas_imagedata = scope.ctx.getImageData(0,0,990,500);
    scope.array_data = new Uint8ClampedArray(scope.canvas_imagedata.data);

    if(window.Worker){

        var myWorker = new Worker("worker.js");

        window.setInterval(function(){
            var lasted_array = $("#main_canvas").get(0).getContext("2d").getImageData(0,0,990,500).data;
            // var lasted_array = document.getElementById("main_canvas").getContext("2d").getImageData(0,0,990,500).data;
            myWorker.postMessage([scope.array_data, lasted_array]);
        },10000);


        myWorker.onmessage = function(e){
            if(e.data["isChanged"] == true){
                scope.array_data = $("#main_canvas").get(0).getContext("2d").getImageData(0,0,990,500).data;
                scope.array_data = new Uint8ClampedArray(scope.array_data);
                scope.socket.emit("array_changed", e.data["change_data"])
            }else{
                console.log("not changed");
            }
        }

             
        scope.socket.on("array_changed", function(msg){
            var lasted_array = $("#main_canvas").get(0).getContext("2d").getImageData(0,0,990,500).data;
            for(var i=0; i<msg.length; i += 2){
                lasted_array[msg[i]] = msg[i+1];
            }
            scope.array_data = new Uint8ClampedArray(lasted_array);
            var imagedata =  new ImageData(lasted_array , scope.canvas_imagedata.width, scope.canvas_imagedata.height);
            $("#main_canvas").get(0).getContext("2d").putImageData(imagedata,0,0);
            console.log("success");
        });
    }
}


function init_video(scope){
    var isChannelReady = false;
    var isInitiator = false;
    var isStarted = false;
    var localStream;
    var pc;
    var remoteStream;
    var turnReady;
    
    var pcConfig = {
      'iceServers': [{
        'urls': 'stun:stun.l.google.com:19302'
      }]
    };
    
    // Set up audio and video regardless of what devices are present.
    var sdpConstraints = {
      offerToReceiveAudio: true,
      offerToReceiveVideo: true
    };
    
    /////////////////////////////////////////////
    
    var room = 'foo';
    // Could prompt for room name:
    // room = prompt('Enter room name:');
    
    // var socket = io.connect();
    
    if (room !== '') {
      scope.socket.emit('create or join', room);
      console.log('Attempted to create or  join room', room);
    }
    
    scope.socket.on('created', function(room) {
      console.log('Created room ' + room);
      isInitiator = true;
    });
    
    scope.socket.on('full', function(room) {
      console.log('Room ' + room + ' is full');
    });
    
    scope.socket.on('join', function (room){
      console.log('Another peer made a request to join room ' + room);
      console.log('This peer is the initiator of room ' + room + '!');
      isChannelReady = true;
    });
    
    scope.socket.on('joined', function(room) {
      console.log('joined: ' + room);
      isChannelReady = true;
    });
    
    scope.socket.on('log', function(array) {
      console.log.apply(console, array);
    });
    
    ////////////////////////////////////////////////
    
    function sendMessage(message) {
      console.log('Client sending message: ', message);
      scope.socket.emit('message', message);
    }
    
    // This client receives a message
    scope.socket.on('message', function(message) {
      console.log('Client received message:', message);
      if (message === 'got user media') {
        maybeStart();
      } else if (message.type === 'offer') {
        if (!isInitiator && !isStarted) {
          maybeStart();
        }
        pc.setRemoteDescription(new RTCSessionDescription(message));
        doAnswer();
      } else if (message.type === 'answer' && isStarted) {
        pc.setRemoteDescription(new RTCSessionDescription(message));
      } else if (message.type === 'candidate' && isStarted) {
        var candidate = new RTCIceCandidate({
          sdpMLineIndex: message.label,
          candidate: message.candidate
        });
        pc.addIceCandidate(candidate);
      } else if (message === 'bye' && isStarted) {
        handleRemoteHangup();
      }
    });
    
    ////////////////////////////////////////////////////
    
    var localVideo = document.querySelector('#localVideo');
    var remoteVideo = document.querySelector('#remoteVideo');
    
    navigator.mediaDevices.getUserMedia({
      audio: false,
      video: true
    })
    .then(gotStream)
    .catch(function(e) {
      alert('getUserMedia() error: ' + e.name);
    });
    
    function gotStream(stream) {
      console.log('Adding local stream.');
      localVideo.src = window.URL.createObjectURL(stream);
      localStream = stream;
      sendMessage('got user media');
      if (isInitiator) {
        maybeStart();
      }
    }
    
    var constraints = {
      video: true
    };
    
    console.log('Getting user media with constraints', constraints);
    
    if (location.hostname !== 'localhost') {
      requestTurn(
        'https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913'
      );
    }
    
    function maybeStart() {
      console.log('>>>>>>> maybeStart() ', isStarted, localStream, isChannelReady);
      if (!isStarted && typeof localStream !== 'undefined' && isChannelReady) {
        console.log('>>>>>> creating peer connection');
        createPeerConnection();
        pc.addStream(localStream);
        isStarted = true;
        console.log('isInitiator', isInitiator);
        if (isInitiator) {
          doCall();
        }
      }
    }
    
    window.onbeforeunload = function() {
      sendMessage('bye');
    };
    
    /////////////////////////////////////////////////////////
    
    function createPeerConnection() {
      try {
        pc = new RTCPeerConnection(null);
        pc.onicecandidate = handleIceCandidate;
        pc.onaddstream = handleRemoteStreamAdded;
        pc.onremovestream = handleRemoteStreamRemoved;
        console.log('Created RTCPeerConnnection');
      } catch (e) {
        console.log('Failed to create PeerConnection, exception: ' + e.message);
        alert('Cannot create RTCPeerConnection object.');
        return;
      }
    }
    
    function handleIceCandidate(event) {
      console.log('icecandidate event: ', event);
      if (event.candidate) {
        sendMessage({
          type: 'candidate',
          label: event.candidate.sdpMLineIndex,
          id: event.candidate.sdpMid,
          candidate: event.candidate.candidate
        });
      } else {
        console.log('End of candidates.');
      }
    }
    
    function handleRemoteStreamAdded(event) {
      console.log('Remote stream added.');
      remoteVideo.src = window.URL.createObjectURL(event.stream);
      remoteStream = event.stream;
    }
    
    function handleCreateOfferError(event) {
      console.log('createOffer() error: ', event);
    }
    
    function doCall() {
      console.log('Sending offer to peer');
      pc.createOffer(setLocalAndSendMessage, handleCreateOfferError);
    }
    
    function doAnswer() {
      console.log('Sending answer to peer.');
      pc.createAnswer().then(
        setLocalAndSendMessage,
        onCreateSessionDescriptionError
      );
    }
    
    function setLocalAndSendMessage(sessionDescription) {
      // Set Opus as the preferred codec in SDP if Opus is present.
      //  sessionDescription.sdp = preferOpus(sessionDescription.sdp);
      pc.setLocalDescription(sessionDescription);
      console.log('setLocalAndSendMessage sending message', sessionDescription);
      sendMessage(sessionDescription);
    }
    
    function onCreateSessionDescriptionError(error) {
      trace('Failed to create session description: ' + error.toString());
    }
    
    function requestTurn(turnURL) {
      var turnExists = false;
      for (var i in pcConfig.iceServers) {
        if (pcConfig.iceServers[i].url.substr(0, 5) === 'turn:') {
          turnExists = true;
          turnReady = true;
          break;
        }
      }
      if (!turnExists) {
        console.log('Getting TURN server from ', turnURL);
        // No TURN server. Get one from computeengineondemand.appspot.com:
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            var turnServer = JSON.parse(xhr.responseText);
            console.log('Got TURN server: ', turnServer);
            pcConfig.iceServers.push({
              'url': 'turn:' + turnServer.username + '@' + turnServer.turn,
              'credential': turnServer.password
            });
            turnReady = true;
          }
        };
        xhr.open('GET', turnURL, true);
        xhr.send();
      }
    }
    
    function handleRemoteStreamAdded(event) {
      console.log('Remote stream added.');
      remoteVideo.src = window.URL.createObjectURL(event.stream);
      remoteStream = event.stream;
    }
    
    function handleRemoteStreamRemoved(event) {
      console.log('Remote stream removed. Event: ', event);
    }
    
    function hangup() {
      console.log('Hanging up.');
      stop();
      sendMessage('bye');
    }
    
    function handleRemoteHangup() {
      console.log('Session terminated.');
      stop();
      isInitiator = false;
    }
    
    function stop() {
      isStarted = false;
      // isAudioMuted = false;
      // isVideoMuted = false;
      pc.close();
      pc = null;
    }
    
    ///////////////////////////////////////////
    
    // Set Opus as the default audio codec if it's present.
    function preferOpus(sdp) {
      var sdpLines = sdp.split('\r\n');
      var mLineIndex;
      // Search for m line.
      for (var i = 0; i < sdpLines.length; i++) {
        if (sdpLines[i].search('m=audio') !== -1) {
          mLineIndex = i;
          break;
        }
      }
      if (mLineIndex === null) {
        return sdp;
      }
    
      // If Opus is available, set it as the default in m line.
      for (i = 0; i < sdpLines.length; i++) {
        if (sdpLines[i].search('opus/48000') !== -1) {
          var opusPayload = extractSdp(sdpLines[i], /:(\d+) opus\/48000/i);
          if (opusPayload) {
            sdpLines[mLineIndex] = setDefaultCodec(sdpLines[mLineIndex],
              opusPayload);
          }
          break;
        }
      }
    
      // Remove CN in m line and sdp.
      sdpLines = removeCN(sdpLines, mLineIndex);
    
      sdp = sdpLines.join('\r\n');
      return sdp;
    }
    
    function extractSdp(sdpLine, pattern) {
      var result = sdpLine.match(pattern);
      return result && result.length === 2 ? result[1] : null;
    }
    
    // Set the selected codec to the first in m line.
    function setDefaultCodec(mLine, payload) {
      var elements = mLine.split(' ');
      var newLine = [];
      var index = 0;
      for (var i = 0; i < elements.length; i++) {
        if (index === 3) { // Format of media starts from the fourth.
          newLine[index++] = payload; // Put target payload to the first.
        }
        if (elements[i] !== payload) {
          newLine[index++] = elements[i];
        }
      }
      return newLine.join(' ');
    }
    
    // Strip CN from sdp before CN constraints is ready.
    function removeCN(sdpLines, mLineIndex) {
      var mLineElements = sdpLines[mLineIndex].split(' ');
      // Scan from end for the convenience of removing an item.
      for (var i = sdpLines.length - 1; i >= 0; i--) {
        var payload = extractSdp(sdpLines[i], /a=rtpmap:(\d+) CN\/\d+/i);
        if (payload) {
          var cnPos = mLineElements.indexOf(payload);
          if (cnPos !== -1) {
            // Remove CN payload from m line.
            mLineElements.splice(cnPos, 1);
          }
          // Remove CN line in sdp
          sdpLines.splice(i, 1);
        }
      }
    
      sdpLines[mLineIndex] = mLineElements.join(' ');
      return sdpLines;
    }
}


function init(scope){
  add_canvas();
  init_canvas(scope);
  init_video(socket);
}
```
```javascript
//main.js
'use strict';

var isChannelReady = false;
var isInitiator = false;
var isStarted = false;
var localStream;
var pc;
var remoteStream;
var turnReady;

var pcConfig = {
  'iceServers': [{
    'urls': 'stun:stun.l.google.com:19302'
  }]
};

// Set up audio and video regardless of what devices are present.
var sdpConstraints = {
  offerToReceiveAudio: true,
  offerToReceiveVideo: true
};

/////////////////////////////////////////////

var room = 'foo';
// Could prompt for room name:
// room = prompt('Enter room name:');

var socket = io.connect();

if (room !== '') {
  socket.emit('create or join', room);
  console.log('Attempted to create or  join room', room);
}

socket.on('created', function(room) {
  console.log('Created room ' + room);
  isInitiator = true;
});

socket.on('full', function(room) {
  console.log('Room ' + room + ' is full');
});

socket.on('join', function (room){
  console.log('Another peer made a request to join room ' + room);
  console.log('This peer is the initiator of room ' + room + '!');
  isChannelReady = true;
});

socket.on('joined', function(room) {
  console.log('joined: ' + room);
  isChannelReady = true;
});

socket.on('log', function(array) {
  console.log.apply(console, array);
});

////////////////////////////////////////////////

function sendMessage(message) {
  console.log('Client sending message: ', message);
  socket.emit('message', message);
}

// This client receives a message
socket.on('message', function(message) {
  console.log('Client received message:', message);
  if (message === 'got user media') {
    maybeStart();
  } else if (message.type === 'offer') {
    if (!isInitiator && !isStarted) {
      maybeStart();
    }
    pc.setRemoteDescription(new RTCSessionDescription(message));
    doAnswer();
  } else if (message.type === 'answer' && isStarted) {
    pc.setRemoteDescription(new RTCSessionDescription(message));
  } else if (message.type === 'candidate' && isStarted) {
    var candidate = new RTCIceCandidate({
      sdpMLineIndex: message.label,
      candidate: message.candidate
    });
    pc.addIceCandidate(candidate);
  } else if (message === 'bye' && isStarted) {
    handleRemoteHangup();
  }
});

////////////////////////////////////////////////////

var localVideo = document.querySelector('#localVideo');
var remoteVideo = document.querySelector('#remoteVideo');

navigator.mediaDevices.getUserMedia({
  audio: false,
  video: true
})
.then(gotStream)
.catch(function(e) {
  alert('getUserMedia() error: ' + e.name);
});

function gotStream(stream) {
  console.log('Adding local stream.');
  localVideo.src = window.URL.createObjectURL(stream);
  localStream = stream;
  sendMessage('got user media');
  if (isInitiator) {
    maybeStart();
  }
}

var constraints = {
  video: true
};

console.log('Getting user media with constraints', constraints);

if (location.hostname !== 'localhost') {
  requestTurn(
    'https://computeengineondemand.appspot.com/turn?username=41784574&key=4080218913'
  );
}

function maybeStart() {
  console.log('>>>>>>> maybeStart() ', isStarted, localStream, isChannelReady);
  if (!isStarted && typeof localStream !== 'undefined' && isChannelReady) {
    console.log('>>>>>> creating peer connection');
    createPeerConnection();
    pc.addStream(localStream);
    isStarted = true;
    console.log('isInitiator', isInitiator);
    if (isInitiator) {
      doCall();
    }
  }
}

window.onbeforeunload = function() {
  sendMessage('bye');
};

/////////////////////////////////////////////////////////

function createPeerConnection() {
  try {
    pc = new RTCPeerConnection(null);
    pc.onicecandidate = handleIceCandidate;
    pc.onaddstream = handleRemoteStreamAdded;
    pc.onremovestream = handleRemoteStreamRemoved;
    console.log('Created RTCPeerConnnection');
  } catch (e) {
    console.log('Failed to create PeerConnection, exception: ' + e.message);
    alert('Cannot create RTCPeerConnection object.');
    return;
  }
}

function handleIceCandidate(event) {
  console.log('icecandidate event: ', event);
  if (event.candidate) {
    sendMessage({
      type: 'candidate',
      label: event.candidate.sdpMLineIndex,
      id: event.candidate.sdpMid,
      candidate: event.candidate.candidate
    });
  } else {
    console.log('End of candidates.');
  }
}

function handleRemoteStreamAdded(event) {
  console.log('Remote stream added.');
  remoteVideo.src = window.URL.createObjectURL(event.stream);
  remoteStream = event.stream;
}

function handleCreateOfferError(event) {
  console.log('createOffer() error: ', event);
}

function doCall() {
  console.log('Sending offer to peer');
  pc.createOffer(setLocalAndSendMessage, handleCreateOfferError);
}

function doAnswer() {
  console.log('Sending answer to peer.');
  pc.createAnswer().then(
    setLocalAndSendMessage,
    onCreateSessionDescriptionError
  );
}

function setLocalAndSendMessage(sessionDescription) {
  // Set Opus as the preferred codec in SDP if Opus is present.
  //  sessionDescription.sdp = preferOpus(sessionDescription.sdp);
  pc.setLocalDescription(sessionDescription);
  console.log('setLocalAndSendMessage sending message', sessionDescription);
  sendMessage(sessionDescription);
}

function onCreateSessionDescriptionError(error) {
  trace('Failed to create session description: ' + error.toString());
}

function requestTurn(turnURL) {
  var turnExists = false;
  for (var i in pcConfig.iceServers) {
    if (pcConfig.iceServers[i].url.substr(0, 5) === 'turn:') {
      turnExists = true;
      turnReady = true;
      break;
    }
  }
  if (!turnExists) {
    console.log('Getting TURN server from ', turnURL);
    // No TURN server. Get one from computeengineondemand.appspot.com:
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4 && xhr.status === 200) {
        var turnServer = JSON.parse(xhr.responseText);
        console.log('Got TURN server: ', turnServer);
        pcConfig.iceServers.push({
          'url': 'turn:' + turnServer.username + '@' + turnServer.turn,
          'credential': turnServer.password
        });
        turnReady = true;
      }
    };
    xhr.open('GET', turnURL, true);
    xhr.send();
  }
}

function handleRemoteStreamAdded(event) {
  console.log('Remote stream added.');
  remoteVideo.src = window.URL.createObjectURL(event.stream);
  remoteStream = event.stream;
}

function handleRemoteStreamRemoved(event) {
  console.log('Remote stream removed. Event: ', event);
}

function hangup() {
  console.log('Hanging up.');
  stop();
  sendMessage('bye');
}

function handleRemoteHangup() {
  console.log('Session terminated.');
  stop();
  isInitiator = false;
}

function stop() {
  isStarted = false;
  // isAudioMuted = false;
  // isVideoMuted = false;
  pc.close();
  pc = null;
}

///////////////////////////////////////////

// Set Opus as the default audio codec if it's present.
function preferOpus(sdp) {
  var sdpLines = sdp.split('\r\n');
  var mLineIndex;
  // Search for m line.
  for (var i = 0; i < sdpLines.length; i++) {
    if (sdpLines[i].search('m=audio') !== -1) {
      mLineIndex = i;
      break;
    }
  }
  if (mLineIndex === null) {
    return sdp;
  }

  // If Opus is available, set it as the default in m line.
  for (i = 0; i < sdpLines.length; i++) {
    if (sdpLines[i].search('opus/48000') !== -1) {
      var opusPayload = extractSdp(sdpLines[i], /:(\d+) opus\/48000/i);
      if (opusPayload) {
        sdpLines[mLineIndex] = setDefaultCodec(sdpLines[mLineIndex],
          opusPayload);
      }
      break;
    }
  }

  // Remove CN in m line and sdp.
  sdpLines = removeCN(sdpLines, mLineIndex);

  sdp = sdpLines.join('\r\n');
  return sdp;
}

function extractSdp(sdpLine, pattern) {
  var result = sdpLine.match(pattern);
  return result && result.length === 2 ? result[1] : null;
}

// Set the selected codec to the first in m line.
function setDefaultCodec(mLine, payload) {
  var elements = mLine.split(' ');
  var newLine = [];
  var index = 0;
  for (var i = 0; i < elements.length; i++) {
    if (index === 3) { // Format of media starts from the fourth.
      newLine[index++] = payload; // Put target payload to the first.
    }
    if (elements[i] !== payload) {
      newLine[index++] = elements[i];
    }
  }
  return newLine.join(' ');
}

// Strip CN from sdp before CN constraints is ready.
function removeCN(sdpLines, mLineIndex) {
  var mLineElements = sdpLines[mLineIndex].split(' ');
  // Scan from end for the convenience of removing an item.
  for (var i = sdpLines.length - 1; i >= 0; i--) {
    var payload = extractSdp(sdpLines[i], /a=rtpmap:(\d+) CN\/\d+/i);
    if (payload) {
      var cnPos = mLineElements.indexOf(payload);
      if (cnPos !== -1) {
        // Remove CN payload from m line.
        mLineElements.splice(cnPos, 1);
      }
      // Remove CN line in sdp
      sdpLines.splice(i, 1);
    }
  }

  sdpLines[mLineIndex] = mLineElements.join(' ');
  return sdpLines;
}

```
```javascript
//my_angular

var not_active = 'list-group-item';
var active = 'list-group-item active';
var tempimage = '';



function all_hide_true(scope){
    scope.empty_panel_hide = true;
    scope.old_file_panel_hide = true;
    scope.image_panel_hide = true;
    scope.friend_panel_hide = true;
    scope.bin_panel_hide = true;

    scope.empty_class = not_active;
    scope.old_class = not_active;
    scope.image_class = not_active;
    scope.friend_class = not_active;
    scope.bin_class = not_active;
}

function load_angular(){
    var app = angular.module('shouye_app', []);
    app.directive("fileread", [function () {
        return {
            scope: {
                fileread: "="
            },
            link: function (scope, element, attributes) {
                element.bind("change", function (changeEvent) {
                    var reader = new FileReader();
                    reader.onload = function (loadEvent) {
                        scope.$apply(function () {
                            scope.fileread = loadEvent.target.result;
                        });
                    }
                    reader.readAsDataURL(changeEvent.target.files[0]);
                });
            }
        }
    }]);


    app.directive('drawcanvas', function(){
        return {
            templateUrl: 'canvas.html',
            replace: true,
            restrict: 'AE',
        }
    });

    app.directive('filebox', function(){
        return {
            templateUrl: 'file_box.html',
            replace: true,
            restrict: 'AE',
        }
    });

    app.directive('binbox', function(){
        return {
            templateUrl: 'bin_box.html',
            replace: true,
            restrict: 'AE',
        }
    });

    app.directive('friendbox', function(){
        return {
            templateUrl: 'friend_box.html',
            replace: true,
            restrict: 'AE',
        }
    });

    app.directive('callfriend', function(){
        return {
            templateUrl: 'call_friend.html',
            replace: true,
            restrict: 'AE',
        }
    });

    app.controller('new_file_controller', function($scope, $http){
        $scope.add_image_ = false;
        $scope.image_url_ = '';
        $scope.image_canvas = [];
        $scope.file_box_canvas = []; //希望从file box的点击编辑调到编辑界面

        $scope.empty_canvas = []


        all_hide_true($scope);
        $scope.empty_panel_click = function(){

            all_hide_true($scope);
            $scope.empty_panel_hide = false;
            $scope.empty_class = active;
            $scope.empty_canvas = [1];
            $scope.image_canvas = []; //将image的canvas删除
            $scope.image_select_hide = false; //将image的选文件恢复
            if($scope.empty_canvas.length == 1){
                window.setTimeout(add_canvas,250);
            }
            // window.setTimeout(add_canvas,1000);
            // add_canvas();    
        };

        $scope.old_panel_click = function(){
            all_hide_true($scope);
            $scope.empty_canvas = [];
            $scope.old_class = active;
            $scope.old_file_panel_hide = false;
        };

        $scope.image_panel_click = function(){
            
            $scope.empty_canvas = []; //将empty panel的canvas删除

            all_hide_true($scope);
            $scope.image_class = active;
            $scope.image_panel_hide = false;
        }

        $scope.friend_panel_click = function(){
            $scope.empty_canvas = [];

            all_hide_true($scope);
            $scope.friend_class = active;
            $scope.friend_panel_hide = false;
        }

        $scope.bin_panel_click = function(){
            $scope.empty_canvas = [];

            all_hide_true($scope);
            $scope.bin_class = active;
            $scope.bin_panel_hide = false;
        }

        $scope.image_canvas_click = function(){
            console.log("image_canvas_click----------");
            if($scope.image_file != undefined){
                $scope.empty_canvas = [];
                $scope.image_select_hide = true;
                $scope.image_canvas = [1];
                window.setTimeout(add_canvas,200);
                window.setTimeout(function(){
                    var img = document.createElement('IMG');
                    img.src = $scope.image_file;
                    window.setTimeout(function(){
                        $("canvas:first").get(0).getContext('2d').drawImage(img,0,0);
                    },200);
                    console.log("draw successfully");
                    $scope.image_file = undefined;
                    $scope.$apply();
                },100);
               
            }
            
        };

        $scope.save_canvas_file = function(){
            
        }
    });

    app.controller('navigator_controller', function($scope, $http) {

        $scope.messages = false;
        $scope.m1 = "../img/message.png";
        $scope.m2 = "../img/message1.png";
        socket.emit("messages", {"cookie":document.cookie});
        socket.on("messages", function(msg){
            if(msg['result']){
                $scope.messages = msg['messages'];
            }
            console.log("messages", )
        });

        $scope.data_list = []
        $scope.$watch('search_value', function(newValue, oldValue) {
            if (newValue === oldValue) {
                return;
            }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
                $scope.data_list.push({"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/1.png"});
            }else{
                $scope.data_list.pop()
            }
            console.log("data changed");
        }, true);
    });
    
    app.controller('add_friend_controller', function($http,$scope){
        socket.on("friend_file", function(msg){
            console.log('friend message',msg);
            $scope.lasted_friend = msg;    
            $scope.$apply();
        });
        socket.emit("friend_file", {"cookie":document.cookie});

        // $scope.lasted_friend = [{'name':'wu','qianming':'be honest','profile':'../images/u_01.png'},
        //     {'name':'qing','qianming':'be honest','profile':'../images/u_02.png'},
        //     {'name':'ze','qianming':'be honest','profile':'../images/u_03.png'}];
       
        $scope.search_friend = [];
        console.log("add_friend_constroller");
        $scope.$watch('search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.search_friend.push({'name':'ze','qianming':'be honest','profile':'../images/u_03.png'});
           }else{
               $scope.search_friend.pop()
           }
        },true);

    });

    app.controller('personal_file_controller', function($http,$scope){
        // $scope.lasted_personal_file = [{"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/1.png"},
        //                                {"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/2.png"},
        //                                {"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/3.png"}];

        // $scope.search_file = [];
        // $scope.$watch('search_value', function(newValue, oldValue) {
        //     if (newValue === oldValue) {
        //         return;
        //     }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
        //         $scope.search_file.push({"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/1.png"});
        //     }else{
        //         $scope.search_file.pop()
        //     }
        // }, true);
        $scope.lasted_file = [];
        $scope.labels = [1,2,3,4];
        $scope.search_file = [];
        socket.on("personal_file", function(msg){
            // console.log('personal file form mysql',msg);
            // 将labels转成数组
            for(var i=0; i<msg.length; i++){
                console.log(msg[i]['labels'].toString().split(" "));
                var labels = msg[i]['labels'].split(' ');
                msg[i]['labels'] = labels;
                console.log(labels);
            }
            
            $scope.lasted_file = msg;    
            // console.log(msg[0][''])
            // $scope.labels = msg[0]['labels'].split(' ');
            console.log('personal file form mysql',msg);
            $scope.$apply();
        });
        socket.emit("personal_file", {"cookie": document.cookie});
        
        // $scope.lasted_file = [{"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/1.png"},
        // {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/2.png"},
        // {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"}];
        $scope.$watch('search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.search_file.push({"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"});
           }else{
               $scope.search_file.pop()
           }
        },true);

        // $scope.modify_image = function(){
        //     console.log("modify_image");
        //     $scope.$parent.file_box_canvas = [1];
        //     window.setTimeout(add_canvas,250);
        // };

    });

    app.controller('cooperation_file_controller', function($http,$scope){
        // $scope.lasted_cooperation_file = [{"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/1.png"},
        // {"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/2.png"},
        // {"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/3.png"}];

        // $scope.search_file = [];
        // $scope.$watch('search_value', function(newValue, oldValue) {
        //     if (newValue === oldValue) {
        //         return;
        //     }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
        //         $scope.search_file.push({"h":"老年","p":"架飞机阿咖酚散放辣椒发了卡机发","img":"../images/1.png"});
        //     }else{
        //         $scope.search_file.pop()
        //     }
        // }, true);

        // $scope.labels = [1,2,3,4];
        $scope.search_file = []
        socket.on("cooperation_file", function(msg){
            for(var i=0; i<msg.length; i++){
                console.log(msg[i]['labels'].toString().split(" "));
                var labels = msg[i]['labels'].split(' ');
                msg[i]['labels'] = labels;
                console.log(labels);
            }
            $scope.lasted_file = msg;    
            $scope.$apply();
        });
        socket.emit("cooperation_file", {"cookie":document.cookie});
        // $scope.lasted_file = [{"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/1.png"},
        // {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/2.png"},
        // {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"}];
        $scope.$watch('search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.search_file.push({"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"});
           }else{
               $scope.search_file.pop()
           }
        },true);

        // $scope.modify_image = function(){
        //     console.log("modify_image");
        //     $scope.$parent.file_box_canvas = [1];
        //     window.setTimeout(add_canvas,250);
        // };
    });

    app.controller('bin_controller', function($http,$scope){
        $scope.labels = [1,2,3,4];
        $scope.search_file = []

        socket.on("bin_file", function(msg){
            for(var i=0; i<msg.length; i++){
                console.log(msg[i]['labels'].toString().split(" "));
                console.log("bin_controller");
                var labels = msg[i]['labels'].split(' ');
                msg[i]['labels'] = labels;
                console.log(labels);
            }
            $scope.lasted_file = msg;    
            $scope.$apply();
        });
        socket.emit("bin_file", {"cookie":document.cookie});

        // $scope.lasted_file = [{"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/1.png"},
        // {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/2.png"},
        // {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"}];
        $scope.$watch('search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.search_file.push({"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"});
           }else{
               $scope.search_file.pop()
           }
        },true);
    });

    app.controller('old_file_controller', function($http, $scope){
        $scope.labels = [1,2,3,4];
        $scope.search_file = []
        $scope.lasted_file = [{"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/1.png"},
        {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/2.png"},
        {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"}];
        $scope.$watch('search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.search_file.push({"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"});
           }else{
               $scope.search_file.pop()
           }
        },true);

        // $scope.modify_image = function(){
        //     console.log("modify_image");
        //     $scope.$parent.file_box_canvas = [1];
        //     window.setTimeout(add_canvas,250);
        // };
    });

    app.controller('new_file_bin_controller', function($http, $scope){
        $scope.labels = [1,2,3,4];
        $scope.search_file = [];
        socket.on("new_bin_file", function(msg){
            for(var i=0; i<msg.length; i++){
                var labels = msg[i]['labels'].split(' ');
                msg[i]['labels'] = labels;
                console.log(labels);
            }
            $scope.lasted_file = msg;   
            console.log('new_file_bin_controller',msg);
            $scope.$apply();
        });
        socket.emit("new_bin_file", {"cookie":document.cookie});

        $scope.lasted_file = [{"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/1.png"},
        {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/2.png"},
        {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"}];
        $scope.$watch('search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.search_file.push({"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"});
           }else{
               $scope.search_file.pop()
           }
        },true);
    });

    app.controller('friend_controller', function($http, $scope){


        socket.on("friend_file", function(msg){
            console.log('friend message',msg);
            $scope.lasted_friend = msg;    
            $scope.$apply();
        });
        socket.emit("friend_file", {"cookie":document.cookie});

        // $scope.lasted_friend = [{'name':'wu','qianming':'be honest','profile':'../images/u_01.png'},
        //     {'name':'qing','qianming':'be honest','profile':'../images/u_02.png'},
        //     {'name':'ze','qianming':'be honest','profile':'../images/u_03.png'}];
       
        $scope.search_friend = [];
        console.log("add_friend_constroller");
        $scope.$watch('search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.search_friend.push({'name':'ze','qianming':'be honest','imageurl':'../images/u_03.png'});
           }else{
               $scope.search_friend.pop()
           }
        },true);
    });
   
    //测试filebox controller
    // app.controller("file_box_controller", function($http,$scope){
    //     $scope.labels = [1,2,3,4];
    //     $scope.search_file = []
    //     $scope.lasted_file = [{"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/1.png"},
    //     {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/2.png"},
    //     {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"}];
    //     $scope.$watch('old_search_value', function(newValue,oldValue){
    //         if (newValue === oldValue) {
    //             return;
    //        }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
    //            $scope.old_search_file.push({'h':'ze','p':'be honest','img':'../images/u_03.png'});
    //        }else{
    //            $scope.old_search_file.pop()
    //        }
    //     },true);

    //     $scope.modify_image = function(){
    //         console.log("modify_image");
    //         $scope.$parent.file_box_canvas = [1];
    //         window.setTimeout(add_canvas,250);
    //     };
    // });

    app.controller("file_box_controller_01", function($http,$scope){
        $scope.labels = [1,2,3,4,9];
        $scope.search_file = []
        $scope.lasted_file = [{"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/1.png"},
        {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/2.png"},
        {"headline":"老年","introduction":"架飞机阿咖酚散放辣椒发了卡机发","image":"../images/3.png"}];
        $scope.$watch('old_search_value', function(newValue,oldValue){
            if (newValue === oldValue) {
                return;
           }else if((newValue.length==1 && oldValue==undefined) || (newValue.length > oldValue.length)){
               $scope.old_search_file.push({'h':'ze','p':'be honest','img':'../images/u_03.png'});
           }else{
               $scope.old_search_file.pop()
           }
        },true);

        $scope.modify_image = function(){
            console.log("modify_image");
            $scope.file_box_canvas = [1];
        }
    });
    
    app.controller("main_controller", function($http,$scope){
        $scope.temp_image = "";

        $scope.main_show = true;
        $scope.temp_panel_show = false;
        $scope.imagepath = '';
        $scope.modify_image = function(imgsrc){
            console.log("modify_image");
            $scope.temp_image = imgsrc;
            // console.log("imgsrc", imgsrc[1].src);
            $scope.imagepath = imgsrc;
            $scope.main_show = false;
            $scope.temp_panel_show = true;
            $scope.empty_canvas = [];
            $scope.image_canvas = [];
            $scope.temp_canvas = [1];
            $scope.temp_save = true;
            var img = document.createElement('IMG');
            img.src = imgsrc;
            window.setTimeout(add_canvas,250);
            window.setTimeout(function(){
                $("canvas:first").get(0).getContext('2d').drawImage(img,0,0);
                $("#save_file_model").get(0).id = "xxx";
                // $(".save")[0].data-toggle = "";
                // $(".save")[0].data-target = "";
                // var modal = $("#save_file_model");
                // modal.parentNode.removeChild(modal);
                // var modal1 = $(".modal-dialog");
                // for(var i=0;i<modal1.length; i++){
                //     modal1[i].parentNode.removeChild(modal1[i]);
                // }
            },300);
        };

        $scope.return_main_panel = function(){
            $("img").each(function(){
                if($(this).attr("id") == $scope.temp_image){
                    $(this).attr("src", $scope.temp_image+"?rnd="+Math.random().toString());
                }
            });
            console.log("return main panel");
            $scope.main_show = true;
            $scope.temp_panel_show = false;
            $scope.empty_canvas = [];
            $scope.image_canvas = [];
            $scope.temp_canvas = [];
            $scope.temp_save = false;
        };

        $scope.save_canvas_file = function(){
            socket.emit("modify_image",{"imagepath":$scope.imagepath,"imagedata":$("canvas:first").get(0).toDataURL()});
            socket.on("modify_image", function(msg){
                if(msg['result'] == true){
                    alert("更新图片成功！");
                }else{
                    alert("更新图片失败");
                }
            });
            console.log("save canvas file temp panel~~~~~~~~");
        };

        $scope.delete_file_bin = function(image){
            // ../images/nongxiaolang@foxmail.com/personal_file/3.png
            // delete_button.hidden = true;
            // $($event.target).addClass("checked");  
            // console.log("delete");
            // alert("delete");
            var table = image.split("/")[image.split("/").length-2];
            socket.emit("delete_file_bin",{"table":table,"image":image,"cookie":document.cookie});
            socket.on("delete_file_bin", function(msg){
                if(msg["result"] == true){
                    socket.emit("personal_file", {"cookie": document.cookie});
                    socket.emit("cooperation_file", {"cookie":document.cookie});
                    socket.emit("bin_file", {"cookie":document.cookie});
                    alert("删除成功！");
                }else{
                    alert("删除失败！");
                }
            });
            
        };

        $scope.recover = function(image){
            var table = image.split("/")[image.split("/").length-2];
            socket.emit("recover",{"table":table,"image":image,"cookie":document.cookie});
            socket.on("recover", function(msg){
                if(msg['result']=true){
                    socket.emit("bin_file", {"cookie":document.cookie});
                    socket.emit("personal_file", {"cookie": document.cookie});
                    socket.emit("cooperation_file", {"cookie":document.cookie});
                    alert("恢复成功");
                }else{
                    alert("恢复失败");
                }
            });
        }

        $scope.totally_delete = function(image){
            socket.emit("totally_delete",{"image":image,"cookie":document.cookie});
            socket.on("totally_delete", function(msg){
                if(msg["result"] == true){
                    socket.emit("bin_file", {"cookie":document.cookie});
                    alert("删除成功！");
                    // window.setTimeout(function(){alert("删除成功！");},1000); 
                }else{
                    alert("删除失败！");
                }
            });
        }

        $scope.search_friend = function(image){
            tempimage = image;
        };
        // $scope.call_friend = function(image){
        //     // window.location.href = "/web/draw.html";
        //     // socket.emit("call_friend", {"image":image,"cookie":document.cookie});
        // }
    });

    app.controller("call_friend_controller", function($http, $scope){
        $scope.friends = [];
        // $scope.image = '';
        socket.on("search_friend", function(msg){
            if(msg['result']){
                $scope.friends = msg['friends'];
                $scope.$apply();
            }
        });
        $scope.$watch('friend', function(newValue, oldValue) {
            if (newValue === oldValue) {
                return;
            }else{
                socket.emit("search_friend",{"cookie":document.cookie,"friend":newValue});
            }
        }, true);

        // $scope.search_friend = function(image){
        //     $scope.image = imtage;
        // };

        $scope.call_friend = function(email){
            // console.log("call friend image", tempimage);
            socket.emit("call_friend", {"image":tempimage,"cookie":document.cookie,"email":email});
            socket.emit("send_message",{'email':email,"cookie":document.cookie,"image":tempimage});
            window.location.href = "/web/draw.html";
            
        }
    });

    app.controller("empty_file_controller", function($http, $scope){
        $scope.save_empty_file = function(){
            console.log("save empty file",$scope.introduction);
            var canvas = $("canvas:first").get(0);
            // console.log(canvas.toDataURL());
            socket.emit('save_empty_file',{"introduction":$scope.introduction,"headline":$scope.headline,"cookie":document.cookie,"imgData":canvas.toDataURL(),"labels":$scope.labels});
            console.log("introduction",$scope.introduction);
            console.log("headline",$scope.headline);
            console.log("labels",$scope.labels);
            socket.on("save_empty_file", function(msg){
                if(msg['result'] == true){ alert("新文件保存成功")}
            });
        }
    });


    app.controller("save_image_file_controller", function($http, $scope){
        $scope.save_empty_file = function(){
            var canvas = $("canvas:first").get(0);
            // console.log(canvas.toDataURL());
            socket.emit('save_empty_file',{"introduction":$scope.introduction,"headline":$scope.headline,"cookie":document.cookie,"imgData":canvas.toDataURL(),"labels":$scope.labels});
            console.log("introduction",$scope.introduction);
            console.log("headline",$scope.headline);
            console.log("labels",$scope.labels);
            socket.on("save_empty_file", function(msg){
                if(msg['result'] == true){ alert("新文件保存成功")}
            });
        };
    });
}


function set_other_not_active(node){
    var children = node.parentNode.childNodes;
    for(var i=0; i<children.length; i++){
        try{
            var name = children[i].className;
            name = name.split("active")[0].trim();
            children[i].className = name;
        }catch(e){
        }
    }
}

function remove_all_child(parent_node){
    var child_nodes = parent_node.childNodes;
    for(var i=child_nodes.length-1; i>=0; i--){
        parent_node.removeChild(child_nodes[i]);
    }
}

```
  
## 我的活动量化
![image](https://raw.githubusercontent.com/ECNU-DEIT-2015/10154507113/master/picture/%E6%B4%BB%E5%8A%A8%E9%87%8F.png)

>  **吴清泽/10152510231/15 commits / 1,090,9041 ++ / 202,461 --/0 issues/**  
## 我的自评
> 在这个项目中，我承担了项目的难点部分的编程，攻破了实时画图的这个难点，实现了自我超越。对Dart语言的学习使我更加熟悉学习一门新的编程语言的流程，更加了解编程的重大意义。我未完成的功能再用5天能够完成。