(function(){var t;(function(){var e=function(t){var e,n;for(e=0,n=0;;)if(e+=t.offsetLeft,n+=t.offsetTop,!(t=t.offsetParent))break;return{x:e,y:n}};t=function(t,n){var o=e(t);return{left:n.pageX-o.x,top:n.pageY-o.y}}})();var e=function(e,n){var o=$(e),i=n.dragging||$.noop,a=n.dragend||$.noop,c=n.dragcontinue||$.noop,s=n.dragpause||$.noop,r=n.dragstart||$.noop;o.each(function(){var e=$.proxy(function(e){return t(this,e)},this),n=$(this),o={down:!1};n.mousedown(function(t){return 1==o.down?!1:(o.down=!0,o.downOffset=e(t),r.call(this,o.downOffset),void 0)}),n.mouseup(function(t){o.down=!1,1==o.move&&(a.call(this,o.downOffset,e(t)),o.move=!1)}),n.mouseout(function(t){o.down&&(s.call(this,e(t)),o.out=!0)});var l=function(t){o.down&&(o.out===!0&&c.call(this,e(t)),o.out=!1,o.move=!0,i.call(this,o.downOffset,e(t)))};n.mousemove(l)})},n={};(function(){n.len=function(t,e){var n=e.left-t.left,o=e.top-t.top;return Math.sqrt(Math.pow(n,2)+Math.pow(o,2))},n.throttle=function(t,e,o){var i,a,c,s=null,r=0;o||(o={});var l=function(){r=o.leading===!1?0:_.now(),s=null,c=t.apply(i,a),i=a=null};return function(){var h=n.now();r||o.leading!==!1||(r=h);var u=e-(h-r);return i=this,a=arguments,0>=u?(clearTimeout(s),s=null,r=h,c=t.apply(i,a),i=a=null):s||o.trailing===!1||(s=setTimeout(l,u)),c}},n.now=Date.now||function(){return(new Date).getTime()}})();var o,i=function(t,e,n){var o=(t.canvas,e.canvas);return{ing:function(t,n){e.clearRect(0,0,o.width,o.height),e.beginPath(),e.moveTo(t.left,t.top),e.lineTo(n.left,n.top),e.stroke()},end:function(i,a){e.clearRect(0,0,o.width,o.height);var c=t.strokeStyle,s=t.lineWidth,r=function(){t.save(),t.strokeStyle=c,t.lineWidth=s,t.beginPath(),t.moveTo(i.left,i.top),t.lineTo(a.left,a.top),t.stroke(),t.restore()};r(),n.stack.push(r),n.rstack=[]}}},a=function(t,e,n){var o=(t.canvas,e.canvas),i=[];return{start:function(t){e.beginPath(),e.lineJoin="round",e.moveTo(t.left,t.top),i.push(t)},ing:function(t,n){e.clearRect(0,0,o.width,o.height),e.lineTo(n.left,n.top),i.push(n),e.stroke()},end:function(){e.clearRect(0,0,o.width,o.height);var a=i.slice(0),c=t.strokeStyle,s=t.lineWidth,r=function(){t.save(),t.strokeStyle=c,t.lineWidth=s,t.beginPath(),$.each(a,function(e,n){0===e?t.moveTo(n.left,n.top):t.lineTo(n.left,n.top)}),t.stroke(),t.restore()};r(),n.stack.push(r),n.rstack=[],i=[]}}};(function(){var t=n.len;o=function(e,n,o){var i=(e.canvas,n.canvas);return{ing:function(e,o){n.clearRect(0,0,i.width,i.height),n.beginPath(),n.arc(e.left+(o.left-e.left)/2,e.top+(o.top-e.top)/2,t(e,o)/2,0,2*Math.PI),n.stroke()},end:function(a,c){n.clearRect(0,0,i.width,i.height);var s=e.strokeStyle,r=e.lineWidth,l=function(){e.save(),e.lineWidth=r,e.strokeStyle=s,e.beginPath(),e.arc(a.left+(c.left-a.left)/2,a.top+(c.top-a.top)/2,t(a,c)/2,0,2*Math.PI),e.stroke(),e.restore()};l(),o.stack.push(l),o.rstack=[]}}}})();var c,s=function(t,e,n){var o=(t.canvas,e.canvas);return{ing:function(t,n){e.clearRect(0,0,o.width,o.height),e.strokeRect(t.left,t.top,n.left-t.left,n.top-t.top)},end:function(i,a){e.clearRect(0,0,o.width,o.height);var c=t.strokeStyle,s=t.lineWidth,r=function(){t.save(),t.lineWidth=s,t.strokeStyle=c,t.strokeRect(i.left,i.top,a.left-i.left,a.top-i.top),t.restore()};r(),n.stack.push(r),n.rstack=[]}}},r=function(t,e,o){var i=(t.canvas,e.canvas),a=[];return{ing:function(o,c){function s(){e.clearRect(0,0,i.width,i.height),e.beginPath(),e.arc(Math.floor(c.left),Math.floor(c.top),10,0,2*Math.PI),e.stroke()}s=n.throttle(s,140),s();var r=function(){t.globalCompositeOperation="destination-out",t.beginPath(),t.arc(Math.floor(c.left),Math.floor(c.top),10,0,2*Math.PI,!0),t.closePath(),t.fill(),t.globalCompositeOperation="source-over"};r(),a.push(r)},end:function(){o.ctx2.clearRect(0,0,o.canvas2.width,o.canvas2.height);var t=a.slice(0);o.stack.push(function(){$.each(t,function(){this()})}),o.rstack=[],o.easeFn=[]}}},l=function(t,e,n){var o=function(t,e,n){t.save(),t.beginPath(),t.moveTo(e.left,e.top),t.lineTo(n.left,n.top),t.fillStyle=t.strokeStyle;var o=Math.atan((n.top-e.top)/(n.left-e.left)),i=Math.PI/2+o;n.left<e.left&&(i-=Math.PI),t.translate(n.left,n.top),t.rotate(i);var a=30/180*Math.PI/2,c=15*Math.tan(a);t.moveTo(0,0),t.lineTo(c,15),t.lineTo(-c,15),t.stroke(),t.fill(),t.restore()};return{start:function(){},ing:function(t,n){e.clearRect(0,0,e.canvas.width,e.canvas.height),o(e,t,n)},end:function(i,a){e.clearRect(0,0,e.canvas.width,e.canvas.height);var c=n.color,s=function(){t.strokeStyle=c,o(t,i,a)};s(),n.stack.push(s),n.rstack=[]}}};(function(){var n=function(){return!1};c=function(n){var c=this;this.option=n||{},this.type=n.type||"rect",this.lineWidth=n.lineWidth||1,this.color=n.color||"rgb(0, 0, 0)",this.stack=[],this.rstack=[];var h=this.canvas1=document.createElement("canvas"),u=this.$canvas1=$(h),f=this.canvas2=document.createElement("canvas"),d=this.$canvas2=$(f),v=u.add(d),p=$("<div></div>").append(u,d);p.css({width:n.width,height:n.height,position:"relative"}),h.width=f.width=n.width,h.height=f.height=n.height,v.css({position:"absolute",left:0,top:0}),p.appendTo(n.parent),h.getContext||(window.G_vmlCanvasManager?(h=window.G_vmlCanvasManager.initElement(h),f=window.G_vmlCanvasManager.initElement(f)):alert("对不起，您的浏览器不支持canvas!"));var g=this.ctx1=h.getContext("2d"),w=this.ctx2=f.getContext("2d"),n=n||{clearBt:null,saveBt:null};g.save(),w.strokeStyle=this.color,g.strokeStyle=this.color,w.lineWidth=this.lineWidth,g.lineWidth=this.lineWidth;var k={};$(f).mousemove(function(e){k=t($(f).get(0),e)});var m={};m.rect=s(g,w,c),m.round=o(g,w,c),m.line=i(g,w,c),m.ease=r(g,w,c),m.curve=a(g,w,c),g.canvas=h,w.canvas=f,m.arrow=l(g,w,c),e(f,{dragstart:function(t){c.refuseSelection(),(m[c.type].start||$.noop)(t)},dragcontinue:function(t){c.refuseSelection(),(m[c.type]["continue"]||$.noop)(t)},dragpause:function(t){c.allowSelection(),(m[c.type].pause||$.noop)(t)},dragging:function(t,e){m[c.type].ing(t,e)},dragend:function(t,e){m[c.type].end(t,e),c.allowSelection()}})},c.prototype={back:function(){this.ctx1.clearRect(0,0,this.canvas1.width,this.canvas1.height);var t=this.stack.pop();t&&this.rstack.push(t),this.drawStack()},forward:function(){this.ctx1.clearRect(0,0,this.canvas1.width,this.canvas1.height);var t=this.rstack.pop();t&&this.stack.push(t),this.drawStack()},drawStack:function(){$.each(this.stack,function(){this&&this()})},setColor:function(t){this.color=this.ctx1.strokeStyle=this.ctx2.strokeStyle=t},setLineWidth:function(t){this.lineWidth=this.ctx1.lineWidth=this.ctx2.lineWidth=t},refuseSelection:function(){$("body").attr("unselectable","on").css({"-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","-o-user-select":"none","user-select":"none"}).bind("selectstart",n),this.clearSelection()},allowSelection:function(){$("body").attr("unselectable","off").css({"-webkit-user-select":"auto","-moz-user-select":"auto","-ms-user-select":"auto","-o-user-select":"auto","user-select":"auto"}).unbind("selectstart",n)},clearSelection:function(){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()},clear:function(){var t=this,e=this.canvas2,n=function(){t.ctx1.clearRect(0,0,e.width,e.height),t.rstack=[]};n(),this.stack.push(n)},save:function(t){return window.getComputedStyle?(window.html2canvas||alert("没有引入 html2canvas.js ，不支持保存绘图功能"),html2canvas($(t)[0]||$(this.option.parent)[0],{onrendered:function(t){var e=t.toDataURL("image/jpeg"),n=window.open();$(n.document.body).append('<img src="'+e+'" />'),n.document.title="保存绘图"}}),void 0):(alert("您的浏览器不支持"),void 0)}}})(),window.DrawBoard=c})();